# Copyright 2018 Red Hat, Inc.
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#      http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
- name: Setting Registry Facts
  set_fact:
    template_registry_domain_name: "{{ registry_domain_name | default(default_domain_name) }}"
    certificate_path: "{{ default_certificate_path }}"
    certificate_subject: "{{ registry_certificate_subject | default(default_certificate_subject) }}"
    nginx_repo_url: "{{ registry_nginx_repo_url | default(default_nginx_repo_url) }}"
    auth_layer: "{{ registry_auth_layer | default(default_auth_layer) }}"

- name: Install Registry
  action: "{{ ansible_pkg_mgr }} name=docker-distribution state=latest"

- name: Enable & Start Registry
  service: name=docker-distribution enabled=yes state=started

- name: Install firewalld
  action: "{{ ansible_pkg_mgr }} name=firewalld state=latest"

#- name: Install firewall-cmd
#  yum: name=firewall-cmd state=latest

- name: Enable Firewalld
  service: name=firewalld enabled=yes state=started

- name: Open Firewall for Registry
  firewalld: port=5000/tcp permanent=yes state=enabled immediate=yes zone=public
  when: not auth_layer | bool

- name: Lay Down Registry Config
  template: src="{{role_path}}/templates/nginx.j2" dest="/etc/docker-distribution/registry/config.xml"
  notify: restart docker registry

- name: Add Auth Layer
  include: "{{role_path}}/tasks/auth_layer_nginx.yaml"
  when: registry_auth_layer | default(false) | bool
