# Copyright 2018 Red Hat, Inc.
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#      http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
# Create a volume for the registry
- hosts: localhost
  vars:
    osp_volumes:
    - name: "{{ full_dns_domain }}-registry"
      display_description: "Registry Vol"
      display_name: "{{ full_dns_domain }}-registry"
      size: "{{ openshift_hosted_registry_storage_volume_size | default(20) }}"
      purpose: "ose_registry"
  roles:
  - infra-ansible/roles/osp/admin-volume

- hosts: OSEv3
  tasks:
  - name: "set cinder registry storage facts"
    set_fact:
      openshift_hosted_registry_storage_openstack_volumeID: "{{ disk.volume.id }}"
      openshift_hosted_registry_storage_volume_size: "{{ disk.volume.size }}Gi"
      openshift_hosted_registry_storage_access_modes: "{{ openshift_hosted_registry_storage_access_modes | default(\"['ReadWriteOnce']\") }}"
      openshift_hosted_registry_storage_openstack_filesystem: "{{ openshift_hosted_registry_storage_openstack_filesystem | default('ext4')}}"
    with_items:
    -  "{{ hostvars['localhost'].os_volumes.results }}"
    when:
    - disk.item.purpose  == "ose_registry"
    loop_control:
      loop_var: disk
